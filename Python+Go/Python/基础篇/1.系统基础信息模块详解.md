> 系统基础信息采集模块作为监控模块的重要组成部分，能够帮助运维人员了解当前系统的健康程度，同时也是衡量业务的服务质量的依据，比如系统资源吃紧，会直接影响业务的服务质量及用户体验，另外获取设备的流量信息，也可以让运维人员更好地评估带宽、设备资源是否应该扩容。本章通过运用Python第三方系统基础模块，可以轻松获取服务关键运营指标数据，包括Linux基本性能、块设备、网卡接口、系统信息、网络地址库等信息。在采集到这些数据后，我们就可以全方位了解系统服务的状态，再结合告警机制，可以在第一时间响应，将异常出现在苗头时就得以处理。

> 本章通过具体的示例来帮助读者学习、理解并掌握。在本章接下来的内容当中，我们的示例将在一个连续的 Python 交互环境中进行。

### 1.1 系统性能信息模块 psutil

> psutil是一个跨平台库(http://code.google.com/p/psutil/)，能够轻松实现获取系统运行的进程和系统利用率(包括CPU、内存、磁盘、网络等)信息。它主要应用于系统监控，分析和限制系统资源及进程的管理。它实现了同等命令行工具提供的功能，如ps、top、Isof、netstat、ifconfig、who、df、kill、free、nice、ionice、iostat、iotop、uptime、 pidof、tty.taskset、pmap等。目前支持32位和64位的Linux、Windows、OS X、FreeBSD和SunSolaris 等操作系统，支持从 2.4到3.4的Python版本，目前最新版本为 2.0.0。通常我们获取操作系统信息往往采用编写shell来实现，如获取当前物理内存总大小及已使用大小，shell命令如下:

```bash
#物理内存total值
[root@localhost ~]# free -m | grep Mem | awk '{print $2}'
#$2：第二列

#物理内存used值
[root@localhost ~]# free -m | grep Mem | awk '{print $3}'
```

> 相比较而言，使用 psutil库实现则更加简单明了。psutil大小单位一般都采用字节，如下:

```python
>>> import psutil
>>> mem = psutil.virtual_memory()
>>> mem.total,mem.used
(1911857152L, 999804928L)

#import psutil：导入了psutil模块。psutil（process and system utilities）是一个跨平台库，用于检索有关运行中进程和系统利用（如内存、CPU、磁盘、网络等）的信息。
#mem = psutil.virtual_memory()：调用psutil.virtual_memory()函数，该函数返回一个namedtuple，包含了不同内存使用情况的统计数据。这个namedtuple包含多个属性，如总内存（total）、已用内存（used）、空闲内存（free）等。
#mem.total,mem.used：获取namedtuple中的两个属性：total和used。mem.total：返回系统的总内存量，单位是字节。mem.used：返回系统已使用的内存量，也是字节。
```

> psutil的源码安装步骤如下:

```bash
#1.Centos7系统初始化
yum install vim lrzsz tree telnet wget lsof net-tools dos2unix sysstat traceroute unzip zip rsync gcc -y
#2.下载psutil-2.0.0.tar.gz
tar -xvzf psutil-2.0.0.tar.gz
[root@localhost ~]# cd psutil-2.0.0
#3.安装Python开发包
yum install python-devel  # 对于Python 2.x
#4.安装
[root@localhost psutil-2.0.0]# python setup.py  install
```

#### 1.1.1 获取系统性能信息

> 采集系统的基本性能信息包括 CPU、内存、磁盘、网络等，可以完整描述当前系统的运行状态及质量。psutil模块已经封装了这些方法，用户可以根据自身的应用场景，调用相应的方法来满足需求，非常简单实用。

> (1)CPU信息
>
> Linux操作系统的CPU 利用率有以下几个部分
>
> User Time，执行用户进程的时间百分比;
> System Time，执行内核进程和中断的时间百分比:;
>
> Wait 10，由于10 等待而使 CPU处于idle(空闲)状态的时间百分比;
>
> ldle，CPU 处于 idle 状态的时间百分比。

> 我们使用 Python的 psutil.cpu_times()方法可以非常简单地得到这些信息，同时也可以获取CPU的硬件相关信息，比如CPU的物理个数与逻辑个数，具体见下面的操作例子:

```python
>>> import psutil
>>> psutil.cpu_times()
scputimes(user=46.9, nice=2.55, system=43.76, idle=2437.96, iowait=2.65, irq=0.0, softirq=3.76, steal=0.0, guest=0.0, guest_nice=0.0)

#调用 cpu_times() 函数时，它返回一个名为 scputimes 的 namedtuple，包含了各种与CPU时间相关的统计数据
#user：用户模式下的CPU时间，表示CPU执行用户进程的时间（单位为秒）
#nice：低优先级（或“nice”）用户模式下的CPU时间。在UNIX-like系统中，"nice"值决定了进程的优先级，数值较高表示优先级较低。这一项表示系统分配给低优先级任务的CPU时间。
#system：内核模式下的CPU时间，表示CPU执行内核和驱动程序代码的时间。
#idle：空闲时间，表示CPU没有被任何程序使用的时间
#iowait： IO等待时间，表示CPU等待磁盘读写操作完成的时间。如果这个数值很高，通常意味着磁盘是系统的瓶颈
#irq：硬件中断请求时间，表示CPU响应硬件中断请求的时间
#softirq：软件中断请求时间，表示CPU响应软件中断请求的时间
#steal：虚拟化环境中，其他操作系统虚拟机占用的CPU时间。在没有虚拟化或者是物理机上，这个值通常是0。
#guest：表示运行虚拟CPU的客户操作系统所占用的CPU时间。
#guest_nice： 表示运行带有'nice'值的虚拟CPU的客户操作系统所占用的CPU时间。
```

```python
>>> import psutil
>>> psutil.cpu_times(percpu=True)
[scputimes(user=17.09, nice=1.31, system=20.28, idle=1934.99, iowait=0.87, irq=0.0, softirq=2.64, steal=0.0, guest=0.0, guest_nice=0.0), scputimes(user=30.34, nice=1.24, system=24.15, idle=1923.74, iowait=1.8, irq=0.0, softirq=1.15, steal=0.0, guest=0.0, guest_nice=0.0)]
#设置 percpu=True 参数意味着你想为每个CPU单独获取这些信息，而不是所有CPU的汇总数据。
#返回的结果是 scputimes 对象的列表，列表中的每个元素对应一个CPU核心的统计数据。这些数据与之前解释的 psutil.cpu_times() 返回的数据类似，但这次是为每个核心分别报告
```

```python
>>> import psutil
>>> psutil.cpu_times().user
47.53
#获取单项数据信息，如用户user的CPU时间比
```

```python
>>> import psutil
>>> psutil.cpu_count()
2
#获取CPU的逻辑个数，默认1ogical=True4
```

```python
>>> psutil.cpu_count(logical=False)
1
#获取CPU的物理颗数
```

(2)内存信息

> Linux系统的内存利用率信息涉及total(内存总数)、used(已使用的内存数)、free(空闲内存数)、buffers(缓冲使用数)、cache(缓存使用数)、swap(交换分区使用数)等，分别使用 psutil.virtual_memory()与psutil.swap_memory()方法获取这些信息，具体见下面的操作例子:

```python
>>> import psutil
>>> mem = psutil.virtual_memory()
>>> mem
svmem(total=1911857152L, available=1645944832L, percent=13.9, used=1013637120L, free=898220032L, active=466243584, inactive=367497216, buffers=2158592L, cached=745566208)
>>> 
#使用psutil.virtual_memory方法获取内存完整信息
>>> mem.total  #获取内存总数
1911857152L
>>> mem.free   #获取内存空闲数
898220032L
```

```python
>>> psutil.swap_memory()
sswap(total=2147479552L, used=0L, free=2147479552L, percent=0.0, sin=0, sout=0)
#获取swap交换分区的信息
```

> (3)磁盘信息
>
> 在系统的所有磁盘信息中，我们更加关注磁盘的利用率及IO信息，其中磁盘利用率使用psutil.disk_usage方法获取。磁盘IO信息包括read_count(读IO数)、write_count(写IO数)、read_bytes(IO读字节数)、write_bytes:(IO写字节数)、read_time(磁盘读时间)write_time(磁盘写时间)等。这些IO信息可以使用psutil.disk_io_counters()获取，具体见下面的操作例子:

```python
>>> import psutil
>>> psutil.disk_partitions()
[sdiskpart(device='/dev/mapper/centos-root', mountpoint='/', fstype='xfs', opts='rw,seclabel,relatime,attr2,inode64,noquota'), sdiskpart(device='/dev/sda1', mountpoint='/boot', fstype='xfs', opts='rw,seclabel,relatime,attr2,inode64,noquota')]
#使用psutil.disk_partitions方法获取磁盘完整信息
```

```python
>>> psutil.disk_usage('/')
sdiskusage(total=18238930944, used=1469235200, free=16769695744, percent=8.1)
#使用psutil.disk_usage方法获取分区(参数)的使用情况
```

```python
>>> psutil.disk_io_counters()
sdiskio(read_count=18691, write_count=29444, read_bytes=407959552, write_bytes=1669417472, read_time=22222, write_time=363652)
#使用psutil.disk_io_counters获取硬盘总的IO个数
```

```python
>>> psutil.disk_io_counters(perdisk=True)
{'sr0': sdiskio(read_count=18, write_count=0, read_bytes=1052672, write_bytes=0, read_time=218, write_time=0), 'dm-1': sdiskio(read_count=94, write_count=0, read_bytes=2281472, write_bytes=0, read_time=287, write_time=0), 'sda2': sdiskio(read_count=8454, write_count=12065, read_bytes=188959744, write_bytes=833671680, read_time=10761, write_time=48179), 'dm-0': sdiskio(read_count=8221, write_count=17379, read_bytes=185228288, write_bytes=833671680, read_time=9935, write_time=315467), 'sda1': sdiskio(read_count=1904, write_count=16, read_bytes=30437376, write_bytes=2138624, read_time=1021, write_time=22)}
#“perdisk=True”参数获取单个分区IO个数
```

> (4)网络信息
>
> 系统的网络信息与磁盘I0类似，涉及几个关键点，包括bytes_sent(发送字节数)bytes_recv=28220119(接收字节数)、packets_sent=200978(发送数据包数)、packets_recv=212672(接收数据包数)等。这些网络信息使用psutil.net_io_counters()方法获取，具体见下面的操作例子:

```python
>>> psutil.net_io_counters()
snetio(bytes_sent=1271117, bytes_recv=117538324, packets_sent=16472, packets_recv=82992, errin=0, errout=0, dropin=0, dropout=0)
>>> 
#使用psutil.net_io_counters获取网络总的IO信息，默认pernic=False
```

```python
>>> import psutil
>>> psutil.net_io_counters(pernic=True)
{'lo': snetio(bytes_sent=0, bytes_recv=0, packets_sent=0, packets_recv=0, errin=0, errout=0, dropin=0, dropout=0), 'ens33': snetio(bytes_sent=1281459, bytes_recv=117554194, packets_sent=16584, packets_recv=83202, errin=0, errout=0, dropin=0, dropout=0)}
#pernic=True输出每个网络接口的IO信息
```

> (5)其他系统信息
>
> 除了前面介绍的几个获取系统基本信息的方法，psutil模块还支持获取用户登录、开机时间等信息，具体见下面的操作例子:

```python
>>> psutil.users()
[suser(name='root', terminal='pts/0', host='192.168.112.1', started=1709463552.0)]
#使用psutil.users方法返回当前登录系统的用户信息
```

```python
>>> import psutil,datetime
>>> psutil.boot_time()
1709463485.0
#使用psutil.boot_time方法获取开始时间，以Linux时间戳格式返回
>>> 
>>> datetime.datetime.fromtimestamp(psutil.boot_time()).strftime("%Y-%m-%d %H:%M:%s")
'2024-03-03 18:58:1709463485'
#转换成自然语言的格式
```

#### 1.1.2 系统进程管理方法